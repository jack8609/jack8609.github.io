<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>違規檢舉小幫手</title>

  <!-- ✅ COI Service Worker -->
  <script src="./coi-serviceworker.min.js"></script>

  <!-- 避免 favicon 404 -->
  <link rel="icon" href="data:," />

  <style>
    /* =========================================================
       Base & Theme Variables
       ========================================================= */
    :root {
      /* 雙滑桿尺寸 */
      --rail-pad: 14px;
      --track-height: 8px;
      --thumb-size: 18px;
      --spacing-v: 18px;
    
      /* 深色主題（預設） */
      --bg: #0e0f12;
      --fg: #e6e6e6;
      --panel: #16181d;
      --border: #262a33;
    
      /* 雙滑桿顏色（深色） */
      --track-bg: #16181d;
      --select-bg: #1e6fd6;
      --accent-color: #35a0ff;
    
      /* 元件色彩 */
      --log-bg: #0a0a0a;
      --log-fg: #86ff91;
      --chip-bg: #0f2338;
      --chip-fg: #bfe3ff;
      --chip-border: #1f3d5e;
      --link-color: #8fbfff;
      --btn-border: var(--border);
      --btn-bg: var(--panel);
      --btn-fg: var(--fg);
      --btn-hover-bg: #222833;
    
      /* 次要文字 */
      --muted-fg: #9aa5b1;
    
      /* 可及性焦點色 */
      --focus-ring: #1e6fd6;
      --focus-ring-light: #2563eb;
      --focus-shadow-alpha: 0.22;
    
      /* 內容最大寬（可依需求調整） */
      --content-max: 960px;
    }
    html { color-scheme: dark light; }

    /* =========================================================
       Light Theme Overrides
       ========================================================= */
    html[data-theme="light"] {
      --bg: #f6f7f9;
      --fg: #111827;
      --panel: #ffffff;
      --border: #d1d5db;
      --track-bg: #ffffff;
      --select-bg: #2563eb;
      --accent-color: #2563eb;
      --log-bg: #f8fafc;
      --log-fg: #0f766e;
      --chip-bg: #e6f0ff;
      --chip-fg: #0b3b77;
      --chip-border: #bfd3ff;
      --link-color: #2563eb;
      --btn-hover-bg: #eef2f7;
      --muted-fg: #6b7280;
      --focus-ring: var(--focus-ring-light);
    }

    /* ====== 按鈕基底 ====== */
    .btn,
    .download-btn,
    .remove-btn {
      appearance: none;
      padding: 6px 14px;
      border-radius: 6px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-fg);
      font-size: 14px;
      cursor: pointer;
      /* 立體感 + 微光澤 */
      box-shadow:
        0 1.5px 3px rgba(0,0,0,0.15),
        inset 0 0 0 rgba(255,255,255,0.12);
      transition:
        background-color .15s ease,
        box-shadow .15s ease,
        transform .1s ease;
    }
    /* ====== hover：浮起來 ====== */
    .btn:hover,
    .download-btn:hover,
    .remove-btn:hover {
      background: var(--btn-hover-bg);
      box-shadow:
        0 3px 6px rgba(0,0,0,0.25),
        inset 0 0 0 rgba(255,255,255,0.2);
      transform: translateY(-1px);
    }
    /* ====== active：按下去 ====== */
    .btn:active,
    .download-btn:active,
    .remove-btn:active {
      transform: translateY(1px);
      box-shadow:
        0 1px 2px rgba(0,0,0,0.2),
        inset 0 0 4px rgba(0,0,0,0.25);
    }

    /* =========================================================
       Theme Toggle
       ========================================================= */
    .theme-toggle input[type="checkbox"] {
      appearance: none;
      width: 30px; height: 10px;
      border-radius: 999px;
      background: #9aa5b1;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background .2s ease;
      border: 0px solid var(--border);
    }
    .theme-toggle input[type="checkbox"]::after {
      content: "";
      position: absolute;
      top: -4px; left: 0px;
      width: 18px; height: 18px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,.2);
      transition: transform .2s ease;
    }
    .theme-toggle input[type="checkbox"]:checked { background: var(--accent-color); }
    .theme-toggle input[type="checkbox"]:checked::after { transform: translateX(18px); }
    .theme-toggle .label { font-size: clamp(10px, 4vw, 13px);; color: inherit; }
    @supports (-webkit-touch-callout: none) {
      .theme-toggle { margin-top: calc(env(safe-area-inset-top) + 8px); }
    }

    /* 父容器：建立定位上下文，並預留右側空間以免 h1 碰到開關 */
    .page-title-bar {
      position: relative;         /* 讓內部 absolute 以此為座標 */
      padding-right: 120px;       /* 預留空間（依你的開關寬度調整） */
      /* 可選：上下留點餘裕 */
      padding-top: 8px;
      padding-bottom: 8px;
    }
    
    /* 標題本身可在窄螢幕換行，避免碰撞 */
    .page-title-bar h1 {
      margin: 0;
      font-weight: 800;
      color: var(--fg);
      white-space: normal;
      overflow-wrap: anywhere;    /* 換行以避免碰到右側開關 */
    }
    
    /* 開關固定在右上角但跟著捲動（因為相對 parent） */
    .page-title-bar .theme-toggle {
      position: absolute;
      top: 50%;
      right: 0px;
      transform: translateY(-70%);  /* 垂直置中；若要貼頂改成 top: 0 即可 */
      z-index: 10;
    
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--fg);
      border-radius: 999px;
      padding: 6px 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }
    
    /* 窄螢幕時縮小右側預留空間與字級，降低碰撞機率 */
    @media (max-width: 420px) {
      .page-title-bar { padding-right: 96px; }
      .page-title-bar h1 { font-size: clamp(16px, 4vw, 24px); }
      .page-title-bar .theme-toggle { right: 0px; }
    }
    
    /* iOS 安全區：避免貼到瀏海或側邊曲面 */
    @supports (-webkit-touch-callout: none) {
      .page-title-bar {
        padding-right: calc(96px + env(safe-area-inset-right));
        padding-top: calc(8px + env(safe-area-inset-top));
      }
    }
    /* =========================================================
       Violation Editor（整合）
       ========================================================= */
    .violation-editor * { box-sizing: border-box; }
    .violation-editor {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
      color: var(--fg);
      background: var(--panel);
      line-height: 1.5;
      width: min(100%, var(--content-max));
      margin-inline: auto;
      max-width: 100%;
      overflow-x: hidden;
    }
    .violation-editor .toolbar {
      display: flex; flex-wrap: wrap; gap: 10px 14px; align-items: center;
      border: 1px solid var(--border); padding: 12px; border-radius: 6px; background: var(--panel);
      max-width: 100%; overflow: hidden;
    }
    .violation-editor .group { display: inline-flex; align-items: center; gap: 8px; flex: 0 1 auto; min-width: 0; }
    @media (max-width: 640px) { .violation-editor .group.full { flex-basis: 100%; } }
    .violation-editor label { font-size: 14px; color: var(--muted-fg); white-space: nowrap; flex: 0 0 auto; }
    .violation-editor input[type="text"],
    .violation-editor input[type="date"],
    .violation-editor select,
    .violation-editor textarea,
    .violation-editor button {
      border: 1px solid var(--border);
      padding: 6px 8px; font-size: 14px; border-radius: 6px;
      background: var(--panel); color: var(--fg); outline: none;
      min-width: 0; max-width: 100%; box-sizing: border-box;
    }
    .violation-editor :is(input, select, textarea, button):focus-visible {
      border-color: var(--focus-ring);
      box-shadow: 0 0 0 3px rgba(30, 111, 214, var(--focus-shadow-alpha));
    }
    
    /* 車牌輸入框 */
    .violation-editor #ve-plate1, .violation-editor #ve-plate2 { width: 80px; }
    .violation-editor .plate-boxes { display: inline-flex; gap: 8px; align-items: center; min-width: 0; }
    .violation-editor .dash { color: var(--muted-fg); user-select: none; }
    
    /* 時間下拉 */
    .violation-editor .time-selects { display: inline-flex; gap: 8px; align-items: center; min-width: 0; }
    .violation-editor .time-selects select { min-width: 80px; }
    
    /* 預覽／輸出 */
    .violation-editor .preview {
      margin-top: 14px; border: 1px solid var(--border); padding: 12px;
      background: var(--panel); border-radius: 6px; max-width: 100%; overflow: hidden;
    }
    .violation-editor textarea#ve-output {
      width: 100%; height: 140px; font-size: 18px; font-weight: 700;
      border: none; background: transparent; resize: vertical; line-height: 1.7; box-sizing: border-box;
    }
    
    /* 控制列與按鈕 */
    .violation-editor .control-row { display: flex; align-items: center; gap: 12px; margin-top: 8px; flex-wrap: wrap; min-width: 0; }
    .violation-editor .btn { background: var(--panel); color: var(--fg); border-color: var(--border); cursor: pointer; }
    .violation-editor .btn:hover { background: var(--btn-hover-bg); border-color: var(--btn-border); }
    
    /* Light 覆寫（提高對比） */
    html[data-theme="light"] .violation-editor label { color: var(--fg); }
    html[data-theme="light"] .violation-editor input[type="text"],
    html[data-theme="light"] .violation-editor input[type="date"],
    html[data-theme="light"] .violation-editor select,
    html[data-theme="light"] .violation-editor textarea,
    html[data-theme="light"] .violation-editor button {
      background: #ffffff; color: var(--fg); border-color: var(--border);
    }
    html[data-theme="light"] .violation-editor .btn:hover { background: var(--btn-hover-bg); border-color: #bfd3ff; }
    
    /* Select（長字串與 iOS 外觀修正） */
    .violation-editor select {
      -webkit-appearance: none; appearance: none;
      background: var(--panel); color: var(--fg); border: 1px solid var(--border);
      width: 100%; max-width: 100%; box-sizing: border-box;
      white-space: normal; text-overflow: ellipsis; overflow: hidden;
    }
    .violation-editor option { background: var(--panel); color: var(--fg); }
    html[data-theme="light"] .violation-editor select { background: #fff; color: var(--fg); border-color: var(--border); }
    html[data-theme="light"] .violation-editor option { background: #fff; color: var(--fg); }

    /* 違規項目列：左短右長 */
    .violation-editor .violation-row {
      display: flex;
      gap: 8px;
      align-items: center;
      min-width: 0;
    }
    
    .violation-editor #city-select {
      flex: 0 0 auto;
      /* 三～四個中文字寬 + 內距、邊框：你可微調為 6em / 96px / 8ch */
      width: 6.5em;          /* 約等於「台中市」寬度 + 些微空間 */
      max-width: 40%;
    }
    
    .violation-editor #ve-violation {
      flex: 1 1 auto;        /* 吃滿剩餘寬度 */
      min-width: 0;          /* 讓文字可縮、避免溢出 */
    }
    
    /* 小螢幕時縣市再短一點，避免擠壓 */
    @media (max-width: 420px) {
      .violation-editor #city-select { width: 5.5em; }
    }

    /* =========================================================
       Global Base & Components
       ========================================================= */
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto;
      margin: 2rem;
    }
    @media (max-width: 480px) { body { margin: 1rem; } }
    h1 { margin-top: 0; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
    }
    .controls { display: flex; align-items: center; gap: .5rem; flex-wrap: wrap; }
    .log {
      overflow: auto; word-break: break-word; overflow-wrap: anywhere;
      white-space: pre-wrap; background: var(--log-bg); color: var(--log-fg);
      padding: 1rem; min-height: 10rem; max-height: 40vh; border-radius: 8px; font-size: 0.92rem;
    }
    button {
      padding: .55rem .85rem; border-radius: 8px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg); color: var(--btn-fg);
      cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .status { margin:.5rem 0; }
    .time { font-variant-numeric: tabular-nums; }
    .chip {
      background: var(--chip-bg); color: var(--chip-fg);
      border: 1px solid var(--chip-border); padding: .2rem .5rem; border-radius: 6px;
    }
    a { color: var(--link-color); }
    .hint { background: var(--panel); color: var(--fg); font-size: .9rem; }
    .col { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 980px) { .col { grid-template-columns: 1.2fr 1fr; } }
    /* 標題顏色 */
    .group-title { margin: .5rem 0 .25rem; font-weight: 600; color: #c9d1d9; }
    html[data-theme="light"] .group-title { color: var(--fg); }

    /* =========================================================
       Media Area & Stacked Slider
       ========================================================= */
    .media-area { padding: 0 var(--rail-pad); }
    .media-area video {
      width: 100%; max-width: 100%; display: block; background: #000; border-radius: 8px;
    }

    .stacked-slider { position: relative; margin-top: .75rem; }
    .stacked-slider .rail {
      position: relative;
      height: calc(var(--spacing-v) * 2 + var(--track-height));
      padding: 0;
    }
    .stacked-slider .track {
      position: absolute; left: 0; right: 0;
      height: var(--track-height); background: var(--track-bg); border-radius: 6px;
    }
    .stacked-slider .track.top { top: 0; }
    .stacked-slider .track.bottom { top: calc(var(--spacing-v) + var(--track-height)); }
    .stacked-slider .selection {
      position: absolute;
      top: calc(var(--spacing-v) / 2 + var(--track-height) / 2);
      height: var(--track-height); background: var(--select-bg);
      border-radius: 6px; pointer-events: none;
    }
    .stacked-slider input[type="range"] {
      position: absolute; left: 0; right: 0; width: 100%;
      margin: 0; background: transparent; -webkit-appearance: none; appearance: none;
      cursor: pointer; height: var(--spacing-v);
    }
    .stacked-slider #startRange { top: 0; }
    .stacked-slider #endRange   { top: var(--spacing-v); }
    .stacked-slider input[type="range"]::-webkit-slider-runnable-track { height: var(--track-height); background: transparent; }
    .stacked-slider input[type="range"]::-moz-range-track { height: var(--track-height); background: transparent; }
    .stacked-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: var(--thumb-size); height: var(--thumb-size);
      border-radius: 50%; background: var(--accent-color);
      border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      margin-top: calc(var(--track-height) / 2 - var(--thumb-size) / 2);
    }
    .stacked-slider input[type="range"]::-moz-range-thumb {
      width: var(--thumb-size); height: var(--thumb-size);
      border-radius: 50%; background: var(--accent-color);
      border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .stacked-slider input[type="range"]:focus-visible {
      outline: none; box-shadow: 0 0 0 3px rgba(30, 111, 214, var(--focus-shadow-alpha));
    }

    /* Log 折疊控制 */
    .log-panel { display: none; }
    .log-panel.show { display: block; }

    /* =========================================================
       Shot Preview & Generated Items
       ========================================================= */
    /* 主體不再強制修補直式白區（由 EditorLite 注入樣式已修正） */
    .shot-box { display: grid; grid-template-columns: 1fr; gap: .75rem; }
    .shot-preview {
      background: var(--panel); border: 1px solid var(--border);
      min-height: 260px; /* 供桌面端，直式具體高度由 EditorLite 斷點接管 */
      min-width: 100%;
      display: flex; align-items: center; justify-content: center;
      border-radius: 8px; overflow: auto; max-width: 100%;
    }
    .shot-preview img { max-width: 100%; height: auto; display: block; }

    /* =========================================================
       RWD（包含 iPhone 兩欄按鈕）
       ========================================================= */
    @media (max-width: 840px) {
      #shotPreview .editor-grid { grid-template-columns: 1fr; gap: 12px; }
      #shotPreview .tool-row { display: flex; flex-wrap: wrap; gap: 8px; min-width: 0; }
      #shotPreview .tool-row .btn {
        flex: 1 1 calc(50% - 8px); /* 手機預設兩欄 */
        min-width: 140px;
        text-align: center;
      }
      #shotPreview .plate-preview {
        display: flex; flex-direction: column; gap: 10px; padding: 10px;
        background: var(--panel); border: 1px dashed var(--border); border-radius: 8px;
        max-width: 100%; overflow-x: hidden;
      }
      #shotPreview .plate-preview .row { width: 100%; display: flex; align-items: center; gap: 8px; min-width: 0; }
      #shotPreview .plate-preview select, #shotPreview .plate-preview input[type="range"] { flex: 1 1 auto; min-width: 0; }
      #shotPreview .plate-preview img { max-width: 180px; height: auto; }
      #shotPreview #drawingOptionsContainer {
        display: flex; flex-direction: column; gap: 10px;
        background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px;
        max-width: 100%; overflow-x: hidden;
      }
      #shotPreview #drawingOptionsContainer .row { width: 100%; display: flex; align-items: center; gap: 8px; min-width: 0; }
      #shotPreview #drawingOptionsContainer select, #shotPreview #drawingOptionsContainer input[type="range"] { flex: 1 1 auto; min-width: 0; }
      #shotPreview .editor-stage { padding: 8px; }
      #staticImageContainer { width: 100%; max-width: 100%; overflow: hidden; }
      #staticImage { max-width: 100%; height: auto; display: block; }
      #shotPreview .editor-stage #drawingOverlay { left: 0; top: 0; width: 100%; height: auto; max-width: 100%; }
      #shotPreview .editor-right {
        max-height: 100%; padding: 10px; background: var(--panel);
        border: 1px solid var(--border); border-radius: 8px; max-width: 100%; overflow-x: hidden;
      }
      #shotPreview #generatedImagesArea { overflow: visible; }
      #shotPreview .generated-image-card { background: var(--panel); border-color: var(--border); border-radius: 8px; padding: 8px; }
      #shotPreview .generated-image-card .inner { background: var(--panel); border-color: var(--border); border-radius: 6px; padding: 6px; }
      #shotPreview .generated-image-card .header { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0; }
      #shotPreview .generated-image-card .btn-row { display: flex; gap: 8px; margin-left: auto; }
      #shotPreview .generated-image-card img { width: 100%; height: auto; display: block; }
    }

    /* iPhone 常見寬度：維持兩欄；超窄退單欄 */
    @media (max-width: 420px) {
      #shotPreview .tool-row { display: flex; flex-wrap: wrap; gap: 8px; overflow: hidden; }
      #shotPreview .tool-row .btn {
        flex: 1 1 calc(50% - 8px);
        min-width: 0; width: auto; white-space: normal;
      }
      .violation-editor .time-selects select { min-width: 0; }
    }
    @media (max-width: 360px) {
      #shotPreview .tool-row .btn { flex: 1 1 100%; min-width: 0; width: 100%; }
      #shotPreview .plate-preview img { max-width: 160px; }
    }

    /* =========================================================
       Hardening（保守保護）
       ========================================================= */
    html, body { overflow-x: hidden; }
    .page, #shotPreview, .violation-editor {
      width: min(100%, var(--content-max)); margin-inline: auto;
    }
    .media-area, .violation-editor, #staticImageContainer, #shotPreview .editor-right {
      max-width: 100%; overflow: hidden;
    }
    img, video, canvas { max-width: 100%; height: auto; display: block; }
    #shotPreview .editor-grid { overflow-x: hidden; }

    .page-title {
      font-size: clamp(16px, 4vw, 24px);
    }
  </style>
</head>
<body>
  <div class="page-title-bar">
    <div class="page-title">
      <h1>違規檢舉小幫手</h1>
    </div>
    <!-- 顯示在畫面最右上角的主題切換開關 -->
    <div class="theme-toggle" role="group" aria-label="主題切換">
      <span class="label" id="themeLabel">深色</span>
      <input type="checkbox" id="themeSwitch" aria-labelledby="themeLabel" />
    </div>
  </div>

  <!-- 檔案選擇與狀態（含「顯示 Log」核取方塊） -->
  <div class="panel">
    <div class="controls">
      <input id="file" type="file" accept="video/*,.ts" />
      <span id="fileInfo" class="hint">請選擇影片（支援 .mp4 / .ts / .mov 等）</span>
    </div>
    <p class="status" id="status" role="status" aria-live="polite">狀態：初始化中…</p>
    <div class="controls">
      <label><input type="checkbox" id="toggleLog" /> 顯示 Log</label>
    </div>
  </div>

  <!-- 主面板：預覽 + 上下雙滑桿 + 按鈕 -->
  <div class="panel">
    <div class="col">
      <!-- 左側：預覽與上下雙滑桿 -->
      <div class="media-area">
        <div>
          <h3>輸出操作</h3>
          <div class="controls">
            <button id="btnClip" class="btn" disabled>剪輯並輸出</button>
            <button id="btnDownloadFull" class="btn" disabled>下載完整轉檔</button>
            <button id="btnThumbnail" class="btn" disabled>擷取縮圖</button>
          </div>
          <p id="out" class="hint"></p>
        </div>

        <video id="preview" controls playsinline></video>
        <div class="time" style="margin-top:.5rem;">
          目前：<span id="cur">00:00:00.00</span> / 片長：<span id="dur">00:00:00.00</span>
        </div>

        <div class="stacked-slider">
          <div class="rail" id="rail">
            <div class="track top"></div>
            <div class="track bottom"></div>
            <div class="selection" id="selection"></div>

            <!-- 上：開始滑桿（初始 0/100） -->
            <input id="startRange" type="range" min="0" max="100" step="0.01" value="0" />
            <!-- 下：結束滑桿（初始就在 100%） -->
            <input id="endRange"   type="range" min="0" max="100" step="0.01" value="100" />
          </div>

          <div class="controls" style="margin-top:.5rem;">
            <span class="chip time" id="startLabel">開始：00:00:00.00</span>
            <span class="chip time" id="endLabel">結束：00:00:00.00</span>
          </div>
        </div>
      </div>

      <!-- 右側：編輯車牌、日期、違規事項區域 -->
      <div>
        <h3 class="group-title">違規資訊</h3>
        <!-- Editor 掛載點（此節點會被 initViolationEditor() 插入內容） -->
        <section id="violation-editor-root"></section>
      </div>
    </div>
  </div>

  <!-- 大型截圖預覽面板 -->
  <div class="panel">
    <h3>截圖預覽</h3>
    <div class="shot-box">
      <div id="shotPreview" class="shot-preview">
        <span class="hint">尚未擷取縮圖</span>
      </div>
    </div>
  </div>

  <!-- Log（預設隱藏；勾選顯示） -->
  <div id="logPanel" class="panel log-panel">
    <h3>Log</h3><button class="btn" id="btnCopyLog">複製</button>
    <div class="log" id="log">Log：</div>
  </div>
  <script type="module" src="./app.js"></script>
    <!-- 從外部載入違規項目選單 -->
  <script src="./violation_list.js"></script>
  
  <footer style="font-size: 12px; opacity: 0.7; text-align:center; margin-top: 40px;">
    本網站使用了 FFmpeg（LGPL v2.1+）之 WebAssembly 核心。
    FFmpeg 原始碼可從官方取得： 
    <a href="https://github.com/FFmpeg/FFmpeg" target="_blank">https://github.com/FFmpeg/FFmpeg</a><br>
    本網站未修改 FFmpeg 核心，僅透過 WebAssembly 作為函式庫使用。
  </footer>
</body>
</html>